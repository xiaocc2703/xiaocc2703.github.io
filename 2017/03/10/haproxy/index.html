
 <!DOCTYPE HTML>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
  
    <title>Linux haproxy | Hello</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="John Doe">
    

    
    <meta name="description" content="应用的状态有二种：    有状态应用    无状态应用java-script：页面动态应用程序 一般由Tomcat服务器来处理jsp的动态页面站点维护的数据分为三类：    结构化数据：关系型数据库存储的数据；如MySQL    半结构化数据：redis为半结构化数据存储系统；    非结构化数据：分布式存储为非结构化数据的存储系统弹性扩展：用云计算可以实现按需的弹性扩展及收缩：docter容器监">
<meta name="keywords" content="Linux,haproxy">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux haproxy">
<meta property="og:url" content="http://yoursite.com/2017/03/10/haproxy/index.html">
<meta property="og:site_name" content="Hello">
<meta property="og:description" content="应用的状态有二种：    有状态应用    无状态应用java-script：页面动态应用程序 一般由Tomcat服务器来处理jsp的动态页面站点维护的数据分为三类：    结构化数据：关系型数据库存储的数据；如MySQL    半结构化数据：redis为半结构化数据存储系统；    非结构化数据：分布式存储为非结构化数据的存储系统弹性扩展：用云计算可以实现按需的弹性扩展及收缩：docter容器监">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-07-10T11:31:56.078Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Linux haproxy">
<meta name="twitter:description" content="应用的状态有二种：    有状态应用    无状态应用java-script：页面动态应用程序 一般由Tomcat服务器来处理jsp的动态页面站点维护的数据分为三类：    结构化数据：关系型数据库存储的数据；如MySQL    半结构化数据：redis为半结构化数据存储系统；    非结构化数据：分布式存储为非结构化数据的存储系统弹性扩展：用云计算可以实现按需的弹性扩展及收缩：docter容器监">

    
    <link rel="alternative" href="/atom.xml" title="Hello" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="Hello" title="Hello"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Hello">Hello</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="Search" />
						<input type="hidden" name="q" value="site:yoursite.com">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/03/10/haproxy/" title="Linux haproxy" itemprop="url">Linux haproxy</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="John Doe" target="_blank" itemprop="author">John Doe</a>
		
  <p class="article-time">
    <time datetime="2017-03-09T16:00:00.000Z" itemprop="datePublished"> Published 2017-03-10</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">Contents</strong>
		
			
		
		</div>
		
		<p>应用的状态有二种：<br>    有状态应用<br>    无状态应用<br>java-script：页面动态应用程序 一般由Tomcat服务器来处理jsp的动态页面<br>站点维护的数据分为三类：<br>    结构化数据：关系型数据库存储的数据；如MySQL<br>    半结构化数据：redis为半结构化数据存储系统；<br>    非结构化数据：分布式存储为非结构化数据的存储系统<br>弹性扩展：用云计算可以实现按需的弹性扩展及收缩：docter容器<br>监控系统是运维工作中的必须的，分类三层监控<br>    硬件故障层；cpu, 硬盘<br>    系统应用层；监听的端口，页面的响应<br>    具体的业务数据本身；同一时间有多少用户访问，服务了多少用户请求，是否超限<br>学习内容：<br>    接入层keepalive<br>    反向代理haproxy<br>    缓存服务器<br>    nosql:rides<br>    分布式文件系统:glusterfs<br>    监控系统zabbix<br>    容器docter<br>    站内搜索引擎elk：日志收集存储分析报告平台<br>haproxy主要功能<br>    反向代理服务器<br>        mode http: 七层反代<br>            ssl/tls 会话卸载器即客户端到反代用ssl加密而反代到后端的web则可以使用明文<br>        mode tcp:四层反代(工作在七层但能处理四层反代又叫伪四层）<br>调度器<br>    四层调度：只是一个管道不需要监听套接字只是起到一个牵头的作用;反代只是客户端发过的的请求转至后端web；因此真正的四层调度是不受套接字限制<br>    七层调度：则需要监听在套接字上;代理服务器本身就是一个web服务器；客户端要跟反代单独建立三次握手，反再充当客户端连接后端web；因此七层调度要受到套接字文件的限制<br>    两级调度：先四层再七层<br>    众多调度算法<br>    http的请求路由到haproxy的安装最佳的后端节点，及静态cookie绑定scesstion会话<br>    健康性检查<br>HAProxy<br>    HAProxy：<br>        <a href="http://www.haproxy.org" target="_blank" rel="noopener">http://www.haproxy.org</a><br>        <a href="http://www.haproxy.com" target="_blank" rel="noopener">http://www.haproxy.com</a> </p>
<pre><code>    文档：
        http://cbonte.github.io/haproxy-dconv/

    程序环境：
        主程序：/usr/sbin/haproxy
        主配置文件：/etc/haproxy/haproxy.cfg
        Unit file：/usr/lib/systemd/system/haproxy.service

    配置段：
        global：全局配置段
            进程及安全配置相关的参数
            性能调整相关参数
            Debug参数
            用户列表
            peers
        proxies：代理配置段
            defaults &lt;name&gt;：为frontend, listen, backend提供默认配置；
            fronted &lt;name&gt;：前端，相当于nginx, server {}
            backend &lt;name&gt;：后端，相当于nginx, upstream {}
            listen &lt;name&gt;：同时拥前端和后端;后端的websrv不被其它的前端调用；前端也不调用其它的后端;
            &lt;name&gt;的格式：区分字符大小写字母，-，_,:等组成

            简单的配置示例：
                frontend web
                    bind *:80
                    default_backend     websrvs

                backend websrvs
                    balance roundrobin
                    server websrv1 172.16.100.6:80 check
                    server websrv2 172.16.100.7:80 check    
                注释：
                    fromtend 前端服务器名
                        bind对外发布的网卡及监听的端口
                        default_backend 默认调度的后端服务器组名
                    backend NAME定义后端服务器组名
                        balance 调度算法
                        server 具体提供web服务器ip及参数
                短连接无状态用roundrobin
                长连接建议使用leastconn

        global配置参数：
            进程及安全管理：chroot, daemon，user, group, uid, gid

                log：定义全局的syslog服务器；最多可以定义两个；
                    log &lt;address&gt; [len &lt;length&gt;] &lt;facility&gt; [max level [min level]]

                nbproc &lt;number&gt;：要启动的haproxy的进程数量；
                ulimit-n &lt;number&gt;：每个haproxy进程可打开的最大文件数，无需手动调master主进程会根据系统需要打开相应的文件数量；
                stats socket /var/lib/haproxy/stats
                    查看haproxy的服务状态及打开图形管理接口
            性能调整：
                maxconn &lt;number&gt;：设定每个haproxy进程所能接受的最大并发连接数； 
                    总体的并发连接数：nbproc * maxconn
                maxconnrate &lt;number&gt;：
                    每个进程每秒种所能创建的最大连接数量；
                maxsessrate &lt;number&gt;：
                    应用层会话，第个进程每秒所能创建的会话速率
                maxsslconn &lt;number&gt;: 
                    设定每个haproxy进程所能接受的ssl的最大并发连接数；
                spread-checks &lt;0..50, in percent&gt;
                    健康状态检查
            注意：
                这里的最大并发连接数可以在server里定义也可以在global中定义、
                    global：所有server的并发连接总数值
                    server：当前server的并发总数

        代理配置段配置参数：

            bind：
                在同一个配置项中bind可使用多次，可以监听在不同端口
                绑定前端服务用来监听接收用户请求的套接字；不能用在defaults，backend中
                bind [&lt;address&gt;]:&lt;port_range&gt; [, ...] [param*]
                示例：
                    listen http_proxy
                        bind :80,:443
                        bind 10.0.0.1:10080,10.0.0.1:10443
                        bind /var/run/ssl-frontend.sock user root mode 600 accept-proxy
                            socket文件路径 文件所有者 权限 代理请求方式
                示例2：
                    加密的端口写法要指明证书路径
                    bind :443 ssl /etc/haproxy/haproxy.pem
                        注意：这个haproxy.pem是证书与私钥的打包文件


            balance：
                后端服务器组内的服务器调度算法
                不能用在frotemd中，其它都可以
                balance &lt;algorithm&gt; [ &lt;arguments&gt; ]
                balance url_param &lt;param&gt; [check_post]                

                算法：
                    roundrobin：
                        加权轮询
                        动态算法：支持权重的运行时调整即不用重启服务也可生效，支持慢启动；每个后端中最多支持4095个server；
                            慢启动：即加入新的web服务器时可以缓慢的分配请求给它而不是一次性，避免易造成死机。

                    static-rr：
                        静态算法：不支持权重的运行时调整及慢启动；后端主机数量无上限；

                    leastconn：
                        动态算法，最少连接调度算法，推荐使用在具有较长会话的场景中，例如MySQL、LDAP等；

                    first：
                        根据服务器在列表中的位置，自上而下进行调度；前面服务器的连接数达到上限，新请求才会分配给下一台服务；

                    source：源地址hash；
                    到底使用用下面两各算法的那一种取决于hash-type
                        除权取余法：
                            缺点：如时增加或减少后端服务器则权重发后变化，会导致调度方向与之前出现偏差
                        一致性哈希：
                            首先有一个2^23的数字hash环;
                            根据后端的web权重来虚拟主机节点，每个服务器有多少权重就虚拟多少个虚拟节点，
                            每个虚拟节点做hash运算对2^23取模，落在hash环的某个点上;
                            源ip做hash运算再对2^23取模，落在hash环的某个点上，
                            然后顺时针旋转找到最近的那个虚拟节点，就由那个虚拟节点对应的服务器提供服务;
                            当后端服务器太少时会有可能造成哈希环偏斜，这时可用权重的倍数到解决
                                后端服务器的权重比乘以100，1000来模拟更多的节点，以达到均匀分布在hash环上的效果
                    uri：
                        对URI的左半部分做hash计算，并由服务器总权重相除以后派发至某挑出的服务器；
                        如果后端是缓存服务时使用此调度算法；而此处法是动态不是静态取决于hash-type
                            URL的组成构架：
                            &lt;scheme&gt;://&lt;user&gt;:&lt;password&gt;@&lt;host&gt;:&lt;port&gt;/&lt;path&gt;;&lt;params&gt;?&lt;query&gt;#&lt;frag&gt;
                                左半部分：/&lt;path&gt;;&lt;params&gt;
                                整个uri：/&lt;path&gt;;&lt;params&gt;?&lt;query&gt;#&lt;frag&gt;
                            示例：
                                backend websrvs
                                    balance uri
                                    hash-type consistent

                    url_param：
                        对用户请求的uri的&lt;params&gt;部分中的参数的值作hash计算，并由服务器总权重相除以后派发至某挑出的服务器；通常用于追踪用户，以确保来自同一个用户的请求始终发往同一个Backend Server；
                        来自于同一个用户的请求发往同一个服务器；
                    hdr(&lt;name&gt;)：
                        基于每个http请求报文的首部某字段，此处由&lt;name&gt;指定的http首部将会被取出做hash计算； 并由服务器总权重相除以后派发至某挑出的服务器；没有有效值的会被轮询调度； 
                        示例：
                            hdr(Cookie)

                        rdp-cookie
                        rdp-cookie(&lt;name&gt;)    
                        示例：
                            backend websrvs
                                balance hdr(User_Agent)
                                hash-type consistent
                            注释：
                            基于浏览器类型的调度
                            User-Agent是请求报文中浏览器类型

                hash-type：哈希算法                        
                        map-based：除权取余法，哈希数据结构是静态的数组；
                        consistent：一致性哈希，哈希数据结构是一个树；

                    &lt;function&gt; is the hash function to be used : 哈希函数
                        sdbm
                        djb2
                        wt6

                default_backend &lt;backend&gt;
                    设定默认的backend，用于frontend中；

                default-server [param*]
                    为backend中的各server设定默认选项；


                server &lt;name&gt; &lt;address&gt;[:[port]] [param*]
                    定义后端主机的各服务器及其选项；                        
                    server &lt;name&gt; &lt;address&gt;[:port] [settings ...]
                    default-server [settings ...]

                    &lt;name&gt;：可自定义，服务器在haproxy上的内部名称；出现在日志及警告信息中；
                    &lt;address&gt;：服务器地址，支持使用主机名；
                    [:[port]]：端口映射；省略时，表示同bind中绑定的端口；
                    [param*]：参数
                        maxconn &lt;number&gt;：当前server的最大并发连接数；
                        backlog &lt;number&gt;：当前server的连接数达到上限后的后援队列长度；
                        backup：设定当前server为备用服务器；当所有服务器当掉才启用
                        check：对当前server做健康状态检测；默认基于四层tcp协议的检测
                            addr ：检测时使用的IP地址；
                            port ：针对此端口进行检测；
                            inter &lt;number&gt;：连续两次检测之间的时间间隔，默认为2000ms; 
                            rise &lt;number&gt;：连续多少次检测结果为“成功”才标记服务器为可用；默认为2；
                            fall &lt;number&gt;：连续多少次检测结果为“失败”才标记服务器为不可用；默认为3；
                            示例：
                                server websrv1 172.20.0.66:80 check inter 1000 rise 2 fall 3

                                注：基于七层应用的健康检测：
                                    option httpchk，&quot;smtpchk&quot;, &quot;mysql-check&quot;, &quot;pgsql-check&quot; and &quot;ssl-hello-chk&quot; 用于定义应用层检测方法；
                                    示例：
                                        backend websrvs
                                            balance ruondrobin
                                            option httpchk GET /test1.html
                                    注:
                                        对后端的所有的web服务器的test1.html页面做检测来判断健康性
                                        需指定GET方法

                                注意：
                                    检测时层级越高则浪费系统资源越多
                        cookie &lt;value&gt;：为当前server指定其cookie值，用于实现基于cookie的会话黏性；
                        disabled：标记为不可用；
                        on-error &lt;mode&gt;：后端服务故障时的行动策略；
                            - fastinter: force fastinter
                            - fail-check: 默认的，快速检测机制
                            - sudden-death: 
                            - mark-down: 
                        redir &lt;prefix&gt;：将发往此server的所有GET和HEAD类的请求重定向至指定的URL；
                            示例：
                                server wdbsrv2 172.20.0.66:80 check redir https://www.baidu.com/
                                所有调度到websrv2的请求都被调度到后面的地址
                        weight &lt;number&gt;：权重，默认为1;                                 

                统计接口启用相关的参数：
                stats enable
                可用在fromtend,backend 中
                    启用统计页；基于默认的参数启用stats page；
                        - stats uri   : /haproxy?stats 
                        - stats realm : &quot;HAProxy Statistics&quot;
                        - stats auth  : 账号:密码
                        - stats scope : 

                        配置示例：
                            listen stats
                                bind :9099
                                stats enable
                                stats realm HAPorxy\ Stats\ Page
                                stats auth admin:admin
                                stats admin if TRUE                                    
                            注释：        
                                stats auth &lt;user&gt;:&lt;passwd&gt;
                                    认证时的账号和密码，可使用多次；
                                stats realm &lt;realm&gt;
                                    认证时的realm；
                                stats uri &lt;prefix&gt;
                                    可自定义默认为/haprocy?stats    
                                stats refresh &lt;delay&gt;
                                    设定自动刷新时间间隔；
                                stats admin if TRUE
                                    启用stats page中的管理功能

                maxconn &lt;conns&gt;：
                不能用在backend中
                为指定的frontend定义其最大并发连接数；默认为2000；

                mode { tcp|http|health }
                    定义haproxy的工作模式；
                        tcp：基于layer4实现代理；可代理mysql, pgsql, ssh, ssl等协议；
                        http：仅当代理的协议为http时使用；
                        health：工作为健康状态检查的响应模式，当连接请求到达时回应“OK”后即断开连接；

                    示例：
                    haproxy对外开放22022端口；能通过这个端口连接后端服务器
                        listen ssh
                            bind :22022
                            balance leastconn
                            mode tcp
                            server sshsrv1 172.16.100.6:22 check
                            server sshsrv2 172.16.100.7:22 check        

                cookie &lt;name&gt; [ rewrite | insert | prefix ] [ indirect ] [ nocache ]  [ postonly ] [ preserve ] [ httponly ] [ secure ]  [ domain &lt;domain&gt; ]* [ maxidle &lt;idle&gt; ] [ maxlife &lt;life&gt; ]
                        &lt;name&gt;：is the name of the cookie which will be monitored, modified or inserted in order to bring persistence.
                            rewirte：重写；
                            insert：插入；
                            prefix：前缀；
                    示例：        
                    基于cookie的session 会话绑定的实现：
                        backend websrvs
                            cookie WEBSRV insert nocache indirect
                            server srv1 172.16.100.6:80 weight 2 check rise 1 fall 2 maxconn 3000 cookie srv1
                            server srv2 172.16.100.7:80 weight 1 check rise 1 fall 2 maxconn 3000 cookie srv2                
                        注：
                            WEBSRV是cookie的key键名
                            cookie srv1代表cookie的值为srv1
                            当用户首次被调度到srv1上时这个k/v会被haproxy记录下来，以后每当这个用户访问都会被调度到srv1上


                option forwardfor [ except &lt;network&gt; ] [ header &lt;name&gt; ] [ if-none ]
                    在defaults中已默认设置;用来记录客户端真实ip地址
                    在由haproxy发往后端主机的请求报文中添加“X-Forwarded-For”首部，其值为前端客户端的地址；用于向后端发送真实的客户端IP；
                        [ except &lt;network&gt; ]：请求报请来自此处指定的网络时不予添加此首部；
                        [ header &lt;name&gt; ]：使用自定义的首部名称，而非“X-Forwarded-For”；
                    注意：
                        只需修改web服务器端日志记录格式
                        vim /etc/httpd/httpd.conf
                            %h ---&gt; %{X-Forwarded-For}i
                        systemctl restart httpd 

                errorfile &lt;code&gt; &lt;file&gt;
                    如果后端服务器返回用户响应报文中的响应码为某个值时，则劫持并返回给客户端本机的某页面
                    &lt;code&gt;：状态码 200, 400, 403, 408, 500, 502, 503, and 504.
                    &lt;file&gt;：可以是本机文件路径，也可是新的url路径

                    示例：
                        errorfile 400 /etc/haproxy/errorfiles/400badreq.http
                        errorfile 408 /dev/null  # workaround Chrome pre-connect bug
                        errorfile 403 /etc/haproxy/errorfiles/403forbid.http
                        errorfile 503 /etc/haproxy/errorfiles/503sorry.http    

                errorloc &lt;code&gt; &lt;url&gt;
                errorloc302 &lt;code&gt; &lt;url&gt;

                    errorfile 403 http://www.magedu.com/error_pages/403.html

                reqadd  &lt;string&gt; [{if | unless} &lt;cond&gt;]
                    添加自己发给后端服务器请求报文的首部

                rspadd &lt;string&gt; [{if | unless} &lt;cond&gt;]
                    添加自己发给客户端响应报文的首部
                    示例：
                        rspadd X-Via:\ HAPorxy

                reqdel  &lt;可用正则&gt; [{if | unless} &lt;cond&gt;]
                    删除自己发给后端服务器请求报文的首部
                reqidel &lt;可用正则&gt; [{if | unless} &lt;cond&gt;]  (ignore case)
                    删除自己发给后端服务器请求报文的首部忽略字符大小写
                rspdel  &lt;可用正则&gt; [{if | unless} &lt;cond&gt;]
                    删除自己发给客户端响应报文的首部
                rspidel &lt;可用正则&gt; [{if | unless} &lt;cond&gt;]  (ignore case)
                    删除自己发给客户端响应报文的首部忽略字符大小写
                    示例：
                        rspidel  ^Server.*


            日志系统：            
                log：
                    log global
                    启用日志方式注意：
                        默认发往本机的日志服务器；
                            vim /etc/rsyslog.conf
                                (1) 加入此行：
                                    local2.*      /var/log/haproxylocal2.log 
                                (2) 启用模块取消注释
                                    $ModLoad imudp
                                    $UDPServerRun 514
                            systemctl restart rsyslog
                log-format &lt;string&gt;：
                    课外实践：参考文档实现combined格式的记录


            为指定的MIME类型启用压缩传输功能
                compression algo &lt;algorithm&gt; ...：启用http协议的压缩机制，指明压缩算法gzip, deflate；
                compression type &lt;mime type&gt; ...：指明压缩的MIME类型；常适用于压缩的类型为文本类型；

            基层级的访问控制：
            可实现条件式的转发调度
            需配合acl来做条件判断
                use_backend &lt;backend&gt; [{if | unless} &lt;condition&gt;]
                    当符合指定的条件时使用特定的后端backend；

                block { if | unless } &lt;condition&gt;
                    工作在七层;对特定url进行阻止
                    示例：
                        acl invalid_src src 172.16.200.2
                        block if invalid_src
                        errorfile 403 /etc/fstab    

                http-request { allow | deny } [ { if | unless } &lt;condition&gt; ]
                    工作在七层

                tcp-request connection {accept|reject}  [{if | unless} &lt;condition&gt;]
                    工作在四层要实现需用mode tcp

                    示例：
                        listen ssh
                            bind :22022
                            balance leastconn
                            acl invalid_src src 172.16.200.2
                            tcp-request connection reject if invalid_src
                            mode tcp
                            server sshsrv1 172.16.100.6:22 check
                            server sshsrv2 172.16.100.7:22 check backup            

acl

    acl &lt;aclname&gt; &lt;criterion&gt; [flags] [operator] [&lt;value&gt;] ...
        &lt;aclname&gt;：

        &lt;value&gt;的类型：
            - boolean 布尔值
            - integer or integer range 正整数
            - IP address / network ip地址段
            - string (exact, substring, suffix, prefix, subdir, domain)
            - regular expression 正则表达式
            - hex block 

        &lt;flags&gt;
            -i : 忽略大小写
            -m : 特殊匹配模式一般不用
            -n : 禁止dns做名字解析
            -u : force the unique id of the ACL
            -- : force end of flags. Useful when a string looks like one of the flags.    

         [operator] 
            匹配整数值：eq、ge、gt、le、lt

            匹配字符串：
                - exact match     (-m str) : 精确匹配
                - substring match (-m sub) : 子字符串匹配
                - prefix match    (-m beg) : 前缀匹配
                - suffix match    (-m end) : 后前缀匹配
                - subdir match    (-m dir) : 子路径匹配
                - domain match    (-m dom) : 子域匹配
                示例：
                /var/www/html
        &lt;criterion&gt; ：
            dst : 目标ip
            dst_port : 目标端口
            src : ip 源ip地址
            src_port : 源端口
                示例：
                acl invalid_src  src  172.16.200.2
            path : string
                This extracts the request&apos;s URL path, which starts at the first slash and ends before the question mark (without the host part).
                /path;&lt;params&gt;

                path     : exact string match
                path_beg : prefix match前缀匹配从uri形始/后面的目录
                path_dir : subdir match子路径匹配
                path_dom : domain match
                path_end : suffix match后缀缀匹配
                path_len : length match路径长度
                path_reg : regex match正则匹配
                path_sub : substring match
                示例：
                    如果url为/var/log/httpd/access
                    path-sub va 则匹配
                    path_dir var 匹配 va不匹配
                示例2：
                /images/jpegs/20180312/logo.jpg
                    path_beg /images/  匹配，除去ip与端口开始是/images/的都匹配
                    path_end .jpg .jpeg .png .gif 匹配，
                    path_reg ^/images.*\.jpeg$ 不匹配，
                    path_sub image 匹配，
                    path_dir jpegs 匹配，
                    path_dom ilinux


            url : string
                This extracts the request&apos;s URL as presented in the request. A typical use is with prefetch-capable caches, and with portals which need to aggregate multiple information from databases and keep them in caches.

                url     : exact string match
                url_beg : prefix match
                url_dir : subdir match
                url_dom : domain match
                url_end : suffix match
                url_len : length match
                url_reg : regex match
                url_sub : substring match

            req.hdr([&lt;name&gt;[,&lt;occ&gt;]]) : string
                基于请求报文的某字段的值进行匹配

                hdr([&lt;name&gt;[,&lt;occ&gt;]])     : exact string match
                hdr_beg([&lt;name&gt;[,&lt;occ&gt;]]) : prefix match
                hdr_dir([&lt;name&gt;[,&lt;occ&gt;]]) : subdir match
                hdr_dom([&lt;name&gt;[,&lt;occ&gt;]]) : domain match
                hdr_end([&lt;name&gt;[,&lt;occ&gt;]]) : suffix match
                hdr_len([&lt;name&gt;[,&lt;occ&gt;]]) : length match
                hdr_reg([&lt;name&gt;[,&lt;occ&gt;]]) : regex match
                hdr_sub([&lt;name&gt;[,&lt;occ&gt;]]) : substring match                    

                示例：
                    acl bad_curl hdr_sub(User-Agent) -i curl
                    block if bad_curl                    

            status : integer
                Returns an integer containing the HTTP status code in the HTTP response.


HAProxy调度算法：
        roundrobin, static-rr
        leastconn
        first
        source
        hdr(&lt;name&gt;)
        uri (hash-type)
        url_param

Nginx调度算法：ip_hash, hash, leastconn, 
lvs调度算法：rr/wrr/sh/dh, lc/wlc/sed/nq/lblc/lblcr


    基于ACL的动静分离示例：
        frontend  web *:80
            acl url_static       path_beg       -i  /static /images /javascript /stylesheets
            acl url_static       path_end       -i  .jpg .gif .png .css .js .html .txt .htm

            use_backend staticsrvs          if url_static
            default_backend             appsrvs

        backend staticsrvs
            balance     roundrobin
            server      stcsrv1 172.16.100.6:80 check

        backend appsrvs
            balance     roundrobin
            server  app1 172.16.100.7:80 check
            server  app1 172.16.100.7:8080 check

        listen stats
            bind :9091
            stats enable
            stats auth admin:admin
            stats admin if TRUE        

配置HAProxy支持https协议： 
    1 支持ssl会话；
        bind *:443 ssl crt /PATH/TO/SOME_PEM_FILE

        crt后的证书文件要求PEM格式，且同时包含证书和与之匹配的所有私钥；

            cat  demo.crt demo.key &gt; demo.pem 

    2 把80端口的请求重向定443；
        bind *:80
        redirect scheme https if !{ ssl_fc }

        另一种配置：对非ssl的任何url的访问统统定向至https主机的主页；
        redirect location https://172.16.0.67/ if !{ ssl_fc }

    3 如何向后端传递用户请求的协议和端口
        http_request set-header X-Forwarded-Port %[dst_port]
        http_request add-header X-Forwared-Proto https if { ssl_fc }

配置时常用的功能：
    http --&gt; https

    mode http
    压缩、条件式转发、算法、stats page、自定义错误页、访问控制、日志功能
    最大并发连接；
        global, defaults, frontend, listen, server 
    基于cookie的session粘滞
    后端主机的健康状态检测
    请求和响应报文首部的操纵
</code></pre>  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/Linux/">Linux</a><a href="/tags/haproxy/">haproxy</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://yoursite.com/2017/03/10/haproxy/" data-title="Linux haproxy | Hello" data-tsina="" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 

<div class="next">
<a href="/2016/06/06/Linux 命令大全/"  title="Linux 命令大全">
 <strong>下一篇：</strong><br/> 
 <span>Linux 命令大全
</span>
</a>
</div>

</nav>

	



</div>  
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
 
 
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  


  

  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Linux/" title="Linux">Linux<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/命令大全/" title="命令大全">命令大全<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/启动流程/" title="启动流程">启动流程<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/haproxy/" title="haproxy">haproxy<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">Links</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://wuchong.me" target="_blank" title="Jark&#39;s Blog">Jark&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">Weibo</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=&verifier=b3593ceb&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Larry Page in Google. <br/>
			This is my blog,believe it or not.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/2176287895" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2018 
		
		<a href="/about" target="_blank" title="John Doe">John Doe</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>











<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
